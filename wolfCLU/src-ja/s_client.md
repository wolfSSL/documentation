### S_CLIENT コマンド — TLS クライアント接続および診断

`wolfssl s_client` コマンドは、リモートサーバに対して
**TLS/SSL クライアント接続を確立し、その挙動を確認・診断するためのユーティリティ**
です。

本コマンドは OpenSSL の `openssl s_client` コマンドと同様の機能を提供し、
以下のような用途で広く使用されます。

- サーバへの TLS 接続性の確認
- サーバ証明書および証明書チェーンの確認
- CA 証明書を用いたサーバ証明書検証
- TLS ハンドシェイクや STARTTLS 動作のデバッグ

---

#### 機能概要

`s_client` コマンドは、指定されたサーバに接続し、
TLS ハンドシェイクを実行します。

指定されたオプションに応じて、以下の動作をサポートします。

- TCP エンドポイントへの直接的な TLS 接続
- SMTP などのプロトコルに対する STARTTLS による TLS 接続
- CA 証明書を用いたサーバ証明書の検証
- 証明書検証失敗時の即時接続終了

本コマンドは、**対話的なテストや診断用途**を目的としており、
本番システムでの自動接続用途を想定したものではありません。

---

#### 接続先の指定

接続先は `-connect` オプションで指定します。  
IPv4 および IPv6 アドレスの両方がサポートされています。

IPv6 アドレスを指定する場合は、角括弧（`[]`）で囲む必要があります。

例:

```sh
-connect 127.0.0.1:443
-connect '[::1]:11111'
-connect '[fe80::63:57c0:9b88:77ca%en0]:11111'
-connect '[2001:4860:4860::8888]:443'
```

#### STARTTLS サポート

`-starttls` オプションを指定することで、
平文通信から TLS に切り替える **STARTTLS** を使用することができます。

STARTTLS は、SMTP などの一部アプリケーションプロトコルにおいて、
初期接続は平文で行い、その後の明示的な要求によって
通信を TLS にアップグレードする仕組みです。

`s_client` コマンドでは、STARTTLS を有効にすると、
以下の流れで通信が行われます。

1. 指定されたサーバおよびポートに平文で接続
2. プロトコル固有の STARTTLS コマンドを送信
3. サーバが STARTTLS を受け入れたことを確認
4. TLS ハンドシェイクを開始

---

##### サポートされているプロトコル

現在、`s_client` コマンドで STARTTLS がサポートされている
プロトコルの例は以下のとおりです。

- `smtp`

> **注意:**  
> サポートされる STARTTLS プロトコルは、
> wolfSSL のビルド構成および実装状況によって異なります。

---

##### 使用例

SMTP サーバに対して STARTTLS を使用する例:

```sh
wolfssl s_client -connect mail.example.com:25 -starttls smtp
```

この場合、SMTP プロトコルに従い、以下の手順で通信が行われます。

1. クライアントが SMTP サーバに平文で接続します。
2. クライアントが `EHLO` コマンドを送信し、サーバの拡張機能を確認します。
3. サーバが `STARTTLS` 拡張をサポートしていることを応答で確認します。
4. クライアントが `STARTTLS` コマンドを送信します。
5. サーバが `STARTTLS` 要求を受け入れると、平文の SMTP セッションは終了します。
6. その後、TLS ハンドシェイクが開始され、通信は暗号化されます。


### 共通オプション

| オプション | 説明 |
|------|-------------|
| `-connect <host:port>` | 接続先サーバのアドレスおよびポート番号 |
| `-starttls <proto>` | 指定したプロトコルで STARTTLS を有効化（例: `smtp`） |
| `-CAfile <file>` | サーバ証明書検証に使用する信頼済み CA 証明書 |
| `-verify_return_error` | 証明書検証に失敗した場合、直ちに接続を終了 |
| `-disable_stdin_check` | セッション中の標準入力の状態チェックを無効化 |

---

### 注意事項

- `-connect` オプションは IPv4 および IPv6 アドレスの両方に対応しています。  
  IPv6 アドレスを指定する場合は、角括弧（`[]`）で囲む必要があります。
- `-starttls` オプションは、SMTP など、平文通信から TLS に
  アップグレードするプロトコルで使用します。
- `-verify_return_error` を指定しない場合、証明書検証に失敗しても、
  設定によっては接続が継続されることがあります。
- `-disable_stdin_check` は、非対話的な実行やスクリプト用途を
  想定したオプションです。

---

### 例

TLS サーバへ接続する例:

```sh
wolfssl s_client -connect example.com:443
```

SMTP で STARTTLS を使用する例:

```sh
wolfssl s_client -connect mail.example.com:25 -starttls smtp
```

証明書検証を行い、失敗時に接続を終了する例:

```sh
wolfssl s_client -connect example.com:443 \
  -CAfile ca-cert.pem \
  -verify_return_error
```


